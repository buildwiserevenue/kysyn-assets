name: Resilient Build 100+ Grammars
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
permissions:
  contents: write
jobs:
  build-all-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Tree-sitter CLI
        run: npm install -g tree-sitter-cli
        
      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.64
          
      - name: Cache Tree-sitter WASI SDK
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/tree-sitter
          key: tree-sitter-wasi-v29
          
      - name: Build Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          [ ! -f languages.txt ] && { echo "âŒ languages.txt mancante"; exit 1; }
          
          mkdir -p grammars
          [ -f versions.json ] || echo "{}" > versions.json
          sed -i 's/\r$//' languages.txt
          
          echo "0" > /tmp/success_count
          echo "0" > /tmp/failed_count
          
          grep -v '^#' languages.txt | while read -r repo_entry; do
            [ -z "$repo_entry" ] && continue
            
            if [[ "$repo_entry" == *":"* ]]; then
              base_repo="${repo_entry%%:*}"
              subdir="${repo_entry##*:}"
              lang_name=$(basename "$subdir")
            else
              base_repo="$repo_entry"
              subdir=""
              lang_name=$(basename "$base_repo" | sed 's/tree-sitter-//')
            fi
            
            echo "ðŸ” $lang_name ($base_repo)..."
            REMOTE_SHA=$(gh api repos/$base_repo/commits/HEAD --template '{{.sha}}' 2>/dev/null || echo "ERROR")
            
            if [ "$REMOTE_SHA" == "ERROR" ]; then
              echo "âš ï¸ Repo non accessibile"
              echo $(($(cat /tmp/failed_count) + 1)) > /tmp/failed_count
              continue
            fi
            
            LOCAL_SHA=$(jq -r ".\"$lang_name\"" versions.json)
            if [ "$REMOTE_SHA" == "$LOCAL_SHA" ] && [ -f "grammars/$lang_name.wasm" ]; then
              echo "â­ï¸ GiÃ  aggiornato"
              continue
            fi
            
            echo "ðŸ—ï¸ Building..."
            rm -rf temp_repo
            if ! timeout 60 git clone --depth 1 "https://github.com/$base_repo.git" temp_repo 2>/dev/null; then
              echo "âŒ Clone fallito"
              echo $(($(cat /tmp/failed_count) + 1)) > /tmp/failed_count
              continue
            fi
            
            cd temp_repo
            [ -n "$subdir" ] && cd "$subdir"
            
            tree-sitter generate 2>/dev/null || true
            if timeout 180 tree-sitter build --wasm 2>/dev/null; then
              generated_wasm=$(find . -name "*.wasm" -maxdepth 1 | head -n 1)
              if [ -n "$generated_wasm" ]; then
                mv "$generated_wasm" "$GITHUB_WORKSPACE/grammars/$lang_name.wasm"
                cd "$GITHUB_WORKSPACE"
                jq ".\"$lang_name\" = \"$REMOTE_SHA\"" versions.json > tmp.json && mv tmp.json versions.json
                echo "âœ… $lang_name"
                echo $(($(cat /tmp/success_count) + 1)) > /tmp/success_count
              else
                echo "âŒ WASM non trovato"
                echo $(($(cat /tmp/failed_count) + 1)) > /tmp/failed_count
              fi
            else
              echo "âŒ Build fallito"
              echo $(($(cat /tmp/failed_count) + 1)) > /tmp/failed_count
            fi
            
            cd "$GITHUB_WORKSPACE"
            rm -rf temp_repo
            sleep 2
          done
          
          echo "SUCCESS=$(cat /tmp/success_count)" >> $GITHUB_ENV
          echo "FAILED=$(cat /tmp/failed_count)" >> $GITHUB_ENV
          
      - name: Commit Results
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Build: ${{ env.SUCCESS }} OK, ${{ env.FAILED }} KO"
          file_pattern: 'grammars/*.wasm versions.json'
