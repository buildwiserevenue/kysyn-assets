name: Smart Build 100+ Grammars
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Controlla aggiornamenti ogni notte

permissions:
  contents: write

jobs:
  build-all-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node & Emscripten
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      
      - name: Install Tree-sitter CLI
        run: npm install -g tree-sitter-cli

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with: { version: 3.1.64 }

      - name: Cache WASI SDK
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/tree-sitter/wasi-sdk
          key: wasi-sdk-29
          
      - name: Cache Emscripten
        uses: actions/cache@v4
        with:
          path: emsdk-cache
          key: emsdk-3.1.64

      - name: Build Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p grammars
          # Crea il file delle versioni se non esiste
          [ -f versions.json ] || echo "{}" > versions.json
          
          sed -i 's/\r//' languages.txt

          grep -v '^#' languages.txt | while read -r repo_entry; do
            [ -z "$repo_entry" ] && continue
            
            if [[ "$repo_entry" == *":"* ]]; then
              base_repo="${repo_entry%%:*}"
              subdir="${repo_entry##*:}"
              lang_name="$subdir"
            else
              base_repo="$repo_entry"
              subdir=""
              lang_name=$(basename "$base_repo" | sed 's/tree-sitter-//')
            fi

            echo "üîç Checking $lang_name ($base_repo)..."

            # 1. Ottieni l'ultimo SHA del commit remoto
            REMOTE_SHA=$(gh api repos/$base_repo/commits/HEAD --template '{{.sha}}')
            # 2. Ottieni lo SHA salvato localmente
            LOCAL_SHA=$(jq -r ".\"$lang_name\"" versions.json)

            # 3. Controlla se dobbiamo compilare
            if [ "$REMOTE_SHA" == "$LOCAL_SHA" ] && [ -f "grammars/$lang_name.wasm" ]; then
              echo "‚è≠Ô∏è $lang_name √® gi√† aggiornato. Skip."
              continue
            fi

            echo "üèóÔ∏è Building $lang_name (New commit: ${REMOTE_SHA:0:7})"

            rm -rf temp_repo
            if ! gh repo clone "$base_repo" temp_repo -- --depth 1; then
              echo "‚ùå Clone failed for $base_repo"
              continue
            fi
            
            cd temp_repo
            [ -n "$subdir" ] && cd "$subdir"
            
            if tree-sitter build --wasm; then
              generated_wasm=$(find . -maxdepth 1 -name "*.wasm" | head -n 1)
              if [ -n "$generated_wasm" ]; then
                mv "$generated_wasm" "$GITHUB_WORKSPACE/grammars/$lang_name.wasm"
                # Aggiorna lo SHA nel file versions.json
                cd "$GITHUB_WORKSPACE"
                jq ".\"$lang_name\" = \"$REMOTE_SHA\"" versions.json > tmp.json && mv tmp.json versions.json
                echo "‚úÖ Success: $lang_name"
              fi
            else
              echo "‚ùå Build failed for $lang_name"
            fi
            
            cd "$GITHUB_WORKSPACE"
            rm -rf temp_repo
            sleep 1
          done

      - name: Commit Results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Smart Update: WASM grammars and versions"
          file_pattern: 'grammars/*.wasm versions.json'