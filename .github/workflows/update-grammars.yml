name: Build 100+ Grammars
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'

permissions:
  contents: write

jobs:
  build-all-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node & Emscripten
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      
      - name: Install Tree-sitter CLI
        run: npm install -g tree-sitter-cli

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with: { version: 3.1.64 }

      - name: Build Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p grammars
          
          # Pulizia: rimuove caratteri speciali invisibili (ritorni a capo Windows)
          sed -i 's/\r//' languages.txt

          grep -v '^#' languages.txt | while read -r repo_entry; do
            [ -z "$repo_entry" ] && continue
            
            echo "--------------------------------------------"
            
            # Gestione sottocartelle (es. typescript:typescript)
            if [[ "$repo_entry" == *":"* ]]; then
              base_repo="${repo_entry%%:*}"
              subdir="${repo_entry##*:}"
              lang_name="$subdir"
            else
              base_repo="$repo_entry"
              subdir=""
              lang_name=$(basename "$base_repo" | sed 's/tree-sitter-//')
            fi

            echo "üèóÔ∏è Building: $lang_name from $base_repo"

            # CLONE USANDO GH CLI (Pi√π stabile contro i blocchi)
            rm -rf temp_repo
            if ! gh repo clone "$base_repo" temp_repo -- --depth 1; then
              echo "‚ùå Clone failed for $base_repo"
              continue
            fi
            
            cd temp_repo
            [ -n "$subdir" ] && cd "$subdir"
            
            # COMANDO AGGIORNATO 2024+
            # Usiamo 'build --wasm' invece del vecchio 'build-wasm'
            if tree-sitter build --wasm; then
              # Il comando genera un file chiamato 'tree-sitter-[lang].wasm'
              generated_wasm=$(find . -maxdepth 1 -name "*.wasm" | head -n 1)
              if [ -n "$generated_wasm" ]; then
                mv "$generated_wasm" "$GITHUB_WORKSPACE/grammars/$lang_name.wasm"
                echo "‚úÖ Success: $lang_name"
              else
                echo "‚ùå .wasm file not found after build"
              fi
            else
              echo "‚ùå Build failed for $lang_name"
            fi
            
            cd "$GITHUB_WORKSPACE"
            rm -rf temp_repo
            
            sleep 2
          done

      - name: Commit Results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Update 100+ WASM grammars"
          file_pattern: 'grammars/*.wasm'